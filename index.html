<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Sonic NFT Holdings (Explorer API)</title>
<style>
  body{font-family:Arial;margin:18px;background:#f6f7fb;color:#111}
  .wrap{max-width:980px;margin:0 auto}
  input{padding:8px;border-radius:6px;border:1px solid #cfd6e3}
  button{padding:8px 12px;border-radius:6px;background:#0b63ff;color:#fff;border:0}
  .cols{display:flex;gap:14px;margin-top:12px}
  .panel{background:#fff;padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(20,20,40,0.05)}
  #list{width:360px;max-height:640px;overflow:auto}
  .item{display:flex;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer}
  .item:hover{background:#f1f5ff}
  .small{font-size:13px;color:#666}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:12px}
  .card{background:#fff;padding:8px;border-radius:8px;text-align:center}
  img{width:100%;height:120px;object-fit:cover;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h3>Sonic NFT Holdings (address input)</h3>
  <div class="small">This page queries the Sonic explorer API (sonicscan.org). Provide a Sonic explorer API key and a wallet address. See Sonic network docs for RPC/explorer details. </div>

  <div style="margin-top:12px">
    <input id="addr" placeholder="0x... wallet address" style="width:360px"/>
    <input id="api" placeholder="Sonic explorer API key" style="width:360px"/>
    <button id="go">Fetch</button>
    <span id="status" class="small" style="margin-left:10px"></span>
  </div>

  <div class="cols" style="margin-top:12px">
    <div class="panel" id="left" style="width:380px">
      <h4 style="margin:0 0 8px 0">Tokens</h4>
      <div id="list">Enter address and click Fetch</div>
    </div>

    <div class="panel" id="right" style="flex:1">
      <h4 style="margin:0 0 8px 0">Selected token</h4>
      <div id="detail"><div class="small">Select a token to view instances.</div></div>
    </div>
  </div>
</div>

<script>
const explorerApiBase = 'https://sonicscan.org/api'; // Sonic explorer (Etherscan-style) API root
const listEl = document.getElementById('list'), detailEl = document.getElementById('detail'), status = document.getElementById('status');

function safe(s){ return String(s||''); }
function ipfsToHttp(u){ if(!u) return ''; if(u.startsWith('ipfs://')) return 'https://ipfs.io/ipfs/'+u.slice(7); return u; }

async function fetchTransfers(address, apiKey, page=1, offset=100){
  // Try ERC-721 transfer endpoint (Etherscan-style)
  const url = `${explorerApiBase}?module=account&action=tokennfttx&address=${address}&page=${page}&offset=${offset}&sort=asc&apikey=${apiKey}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('Explorer API error '+r.status);
  return r.json();
}

async function fetch1155Transfers(address, apiKey, page=1, offset=100){
  // Some explorers expose a token1155tx action; try it, but ignore errors if not supported.
  const url = `${explorerApiBase}?module=account&action=token1155tx&address=${address}&page=${page}&offset=${offset}&sort=asc&apikey=${apiKey}`;
  const r = await fetch(url);
  if(!r.ok) return {status:'0',result:[]};
  return r.json();
}

function groupByToken(records){
  const map = {};
  records.forEach(tx=>{
    const key = (tx.contractAddress||tx.contractAddress||tx.tokenAddress||'').toLowerCase() + '|' + (tx.tokenID||tx.tokenId||tx.tokenID||tx.tokenId||tx.tokenID||'');
    if(!map[key]) map[key] = {contract:tx.contractAddress||tx.tokenAddress, tokenId:tx.tokenID||tx.tokenId||tx.tokenID, tokenType:tx.tokenType||'ERC-721', title:tx.tokenName||tx.tokenSymbol||tx.tokenID||'', count:0, txs:[]};
    // compute net holdings by counting incoming vs outgoing
    const from = (tx.from||'').toLowerCase(), to = (tx.to||'').toLowerCase();
    map[key].txs.push(tx);
    // treat each transfer as 1 unless quantity field exists
    const qty = Number(tx.value || tx.quantity || tx.amount || 1);
    // We'll compute net later
  });
  // compute net holdings
  Object.values(map).forEach(g=>{
    let net = 0;
    g.txs.forEach(tx=>{
      const from = (tx.from||'').toLowerCase(), to = (tx.to||'').toLowerCase();
      // if to is our address -> +qty; if from is our address -> -qty
      // we don't know the queried address here; store txs and compute later in caller
    });
  });
  return map;
}

document.getElementById('go').onclick = async ()=>{
  const addr = (document.getElementById('addr').value||'').trim();
  const api = (document.getElementById('api').value||'').trim();
  listEl.innerHTML = ''; detailEl.innerHTML = '<div class="small">Select a token to view instances.</div>'; status.textContent='';
  if(!addr) return status.textContent='Enter address';
  if(!api) return status.textContent='Enter Sonic explorer API key';
  status.textContent='Fetching transfers...';
  try{
    // fetch ERC-721 transfers (page 1 only for simplicity)
    const r1 = await fetchTransfers(addr, api, 1, 200);
    const r2 = await fetch1155Transfers(addr, api, 1, 200).catch(()=>({status:'0',result:[]}));
    const all = [];
    if(r1 && r1.status==='1') all.push(...r1.result);
    if(r2 && r2.status==='1') all.push(...r2.result);
    if(all.length===0){ listEl.innerHTML = '<div class="small">No NFT transfer records found on Sonic explorer.</div>'; status.textContent='Done'; return; }
    // compute net holdings per token
    const map = {};
    all.forEach(tx=>{
      const contract = (tx.contractAddress||tx.tokenAddress||'').toLowerCase();
      const tokenId = tx.tokenID||tx.tokenId||tx.tokenID||tx.tokenID||tx.tokenID||'';
      const key = contract+'|'+tokenId;
      if(!map[key]) map[key] = {contract, tokenId, name:tx.tokenName||tx.tokenSymbol||contract, tokenType: tx.tokenType||'ERC-721', image: ipfsToHttp(tx.tokenImage||tx.tokenURI||''), txs:[], count:0};
      map[key].txs.push(tx);
    });
    // compute net for each token relative to the queried address
    Object.values(map).forEach(g=>{
      let net = 0;
      g.txs.forEach(tx=>{
        const from = (tx.from||'').toLowerCase(), to = (tx.to||'').toLowerCase();
        const qty = Number(tx.value || tx.quantity || tx.amount || 1);
        if(to === addr.toLowerCase()) net += qty;
        if(from === addr.toLowerCase()) net -= qty;
      });
      g.count = net;
    });
    // filter out zero or negative holdings
    const held = Object.values(map).filter(x=>x.count>0).sort((a,b)=>b.count-a.count);
    if(held.length===0){ listEl.innerHTML = '<div class="small">No current holdings found on Sonic (net = 0 for all tokens).</div>'; status.textContent='Done'; return; }
    // render list
    held.forEach(h=>{
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<div><div style="font-weight:600">${h.name||h.contract}</div><div class="small">${h.contract} • ID ${h.tokenId}</div></div><div style="font-weight:700">${h.count}</div>`;
      div.onclick = ()=> showDetail(h, addr);
      listEl.appendChild(div);
    });
    status.textContent = `Found ${held.length} token types held (page 1).`;
  } catch(e){
    status.textContent = 'Error: '+e.message;
  }
};

function showDetail(h, owner){
  detailEl.innerHTML = `<div style="display:flex;justify-content:space-between"><div><div style="font-weight:700">${h.name}</div><div class="small">${h.contract} • ID ${h.tokenId}</div></div><div style="text-align:right"><div class="small">Held</div><div style="font-weight:800">${h.count}</div></div></div><div id="instances" class="grid"></div>`;
  const grid = document.getElementById('instances');
  // create 'count' cards using available tx metadata where possible
  for(let i=0;i<h.count;i++){
    const c = document.createElement('div'); c.className='card';
    const img = h.image || 'https://via.placeholder.com/300';
    c.innerHTML = `<img src="${img}" onerror="this.src='https://via.placeholder.com/300'"/><div class="small" style="margin-top:8px">${h.name} #${h.tokenId}</div>`;
    grid.appendChild(c);
  }
}
</script>
</body>
</html>
