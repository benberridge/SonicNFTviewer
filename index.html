<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonic On‑chain NFT Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    1) Primary ethers v6 UMD (global window.ethers).
       This should succeed in most environments.
  -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <!--
    2) Resilient fallback: if the primary CDN fails, try unpkg.
       This ensures window.ethers exists before our app runs.
  -->
  <script>
    (function ensureEthersLoaded() {
      function inject(src, onload, onerror) {
        var s = document.createElement("script");
        s.src = src;
        s.async = false;
        s.onload = onload;
        s.onerror = onerror;
        document.head.appendChild(s);
      }
      function tryFallback() {
        if (typeof window.ethers !== "undefined") return;
        inject(
          "https://unpkg.com/ethers@6.11.1/dist/ethers.umd.min.js",
          function () { console.log("Loaded ethers from unpkg fallback."); },
          function () { console.error("All ethers.js CDN fallbacks failed."); }
        );
      }
      // If the primary load fails (blocked network/CSP/SRI, etc.), add a fallback
      if (typeof window.ethers === "undefined") {
        // Wait a tick in case the primary <script> just hasn’t executed yet
        setTimeout(tryFallback, 100);
      }
    })();
  </script>

  <style>
    :root { --bg:#0b0e13; --panel:#131823; --txt:#e6e9ef; --muted:#9aa3b2; --accent:#66e7ff; --danger:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap { max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size:1.6rem; margin:.25rem 0 .5rem; }
    .muted { color:var(--muted); }
    .small { font-size:.9rem; }
    .card { background:var(--panel); border:1px solid #202636; border-radius:12px; padding:1rem; }
    label { display:block; font-size:.9rem; color:var(--muted); margin:.75rem 0 .25rem; }
    input[type="text"] { width:100%; padding:.7rem .8rem; border:1px solid #263044; border-radius:10px; background:#0f1420; color:var(--txt); }
    .row { display:grid; grid-template-columns: 1fr auto; gap:.75rem; align-items:end; }
    button { padding:.75rem 1rem; background:var(--accent); color:#00242b; border:0; border-radius:10px; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .cols { display:grid; gap:1rem; grid-template-columns: 1fr 1fr; margin-top:1rem; }
    .list { min-height: 160px; border:1px dashed #2b3448; border-radius:10px; padding:.75rem; }
    .error { color:var(--danger); margin-top:.5rem; }
    @media (max-width: 860px){ .cols { grid-template-columns: 1fr; } }
    .token { padding:.45rem .6rem; border:1px solid #263044; border-radius:8px; margin-bottom:.5rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sonic On‑chain NFT Scanner</h1>
      <p class="muted small">Runs only on RPC calls (no explorer API key).</p>
    </header>

    <section class="card">
      <!-- Fixed RPC: no user entry required -->
      <input type="hidden" id="rpcUrl" value="https://rpc.soniclabs.com" />

      <label for="wallet">Wallet address</label>
      <div class="row">
        <input id="wallet" type="text" placeholder="0x… wallet address" autocomplete="off" />
        <button id="scanBtn">Scan</button>
      </div>
      <div id="status" class="muted small" style="margin-top:.5rem;"></div>
      <div id="error" class="error" role="alert"></div>
    </section>

    <section class="cols">
      <div class="card">
        <h3 style="margin:.25rem 0 .5rem;">Tokens Found</h3>
        <div id="tokens" class="list muted small">No results yet</div>
      </div>
      <div class="card">
        <h3 style="margin:.25rem 0 .5rem;">Selected token</h3>
        <div id="selected" class="list muted small">Select a token to view instances.</div>
      </div>
    </section>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => { $("status").textContent = msg ?? ""; };
    const setError  = (msg) => { $("error").textContent  = msg ?? ""; };
    const clearMsgs = () => { setStatus(""); setError(""); };
    const disable   = (el, on = true) => el && (el.disabled = !!on);

    function requireEthersOrShow() {
      if (typeof window.ethers === "undefined") {
        setError("Failed to load ethers.js. Check network/CSP or self‑host ethers. See console for details.");
        console.error("window.ethers is undefined. Verify CDN accessibility or CSP.");
        return false;
      }
      return true;
    }

    // Validate hex EOA/contract address (ethers v6 global API)
    function isAddress(addr) {
      try { return window.ethers.isAddress(addr); } catch { return false; }
    }

    function createProvider() {
      const rpc = $("rpcUrl").value.trim();                 // Fixed Sonic RPC
      return new window.ethers.JsonRpcProvider(rpc);        // v6 provider
    }

    // ---------- Scan Logic (stub you can extend) ----------
    async function scanAddress() {
      clearMsgs();
      if (!requireEthersOrShow()) return;

      const wallet = $("wallet").value.trim();
      if (!wallet)      return setError("Please enter a wallet address.");
      if (!isAddress(wallet)) return setError("That doesn’t look like a valid address.");

      const btn = $("scanBtn");
      disable(btn, true);
      setStatus("Connecting to RPC and validating address…");

      try {
        const provider = createProvider();

        // Check RPC health quickly
        const [network, latest] = await Promise.all([
          provider.getNetwork(),
          provider.getBlockNumber()
        ]);
        setStatus(`Connected to chain ${Number(network.chainId)} • latest block ${latest}. Scanning…`);

        // TODO: Replace the placeholder below with real NFT discovery:
        //  - Query ERC‑721 Transfer logs
        //  - Query ERC‑1155 TransferSingle/TransferBatch logs
        //  - Use topics with the wallet in from/to to narrow event scans
        const tokensEl = $("tokens");
        tokensEl.textContent = "";
        tokensEl.classList.remove("muted");

        const sample = document.createElement("div");
        sample.className = "token";
        sample.innerHTML = `
          <div><strong>Sample Token</strong> (replace with actual results)</div>
          <div class="small muted">Chain: ${Number(network.chainId)} • Block: ${latest}</div>
        `;
        tokensEl.appendChild(sample);

        $("selected").textContent = "Click a token to view instances (not wired yet).";
        setStatus("Scan complete.");
      } catch (err) {
        console.error(err);
        setError(err?.message || "Scan failed. See console for details.");
      } finally {
        disable(btn, false);
      }
    }

    // ---------- Wire UI ----------
    window.addEventListener("DOMContentLoaded", () => {
      if (!requireEthersOrShow()) {
        // If you consistently see this, either relax CSP, add CDN to script-src, or self‑host ethers.umd.min.js locally.
        return;
      }
      $("scanBtn").addEventListener("click", (e) => { e.preventDefault(); scanAddress(); });
      $("wallet").addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); scanAddress(); }
      });
    });
  </script>
</body>
</html>
