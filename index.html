<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonic On‑chain NFT Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ethers v6 (fixes “ethers is not defined”) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js"
          integrity="sha384-v6xCDN-ethers-6-11-1"
          crossorigin="anonymous"></script>

  <style>
    :root { --bg:#0b0e13; --panel:#131823; --txt:#e6e9ef; --muted:#9aa3b2; --accent:#66e7ff; --danger:#ff6b6b; }
    body { margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--txt); }
    .wrap { max-width: 920px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size:1.6rem; margin:.25rem 0 1rem; }
    .card { background:var(--panel); border:1px solid #202636; border-radius:12px; padding:1rem; }
    label { display:block; font-size:.9rem; color:var(--muted); margin:.75rem 0 .25rem; }
    input[type="text"] { width:100%; padding:.7rem .8rem; border:1px solid #263044; border-radius:10px; background:#0f1420; color:var(--txt); }
    .row { display:grid; grid-template-columns: 1fr auto; gap:.75rem; align-items:end; }
    button { padding:.75rem 1rem; background:var(--accent); color:#00242b; border:0; border-radius:10px; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .muted { color:var(--muted); }
    .error { color:var(--danger); margin-top:.5rem; }
    .cols { display:grid; gap:1rem; grid-template-columns: 1fr 1fr; margin-top:1rem; }
    .list { min-height: 140px; border:1px dashed #2b3448; border-radius:10px; padding:.75rem; }
    @media (max-width: 840px){ .cols { grid-template-columns: 1fr; } }
    .small { font-size:.85rem; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Sonic On‑chain NFT Scanner</h1>
      <p class="muted small">Runs only on RPC calls (no explorer API key).</p>
    </header>

    <section class="card">
      <!-- RPC is fixed & hidden—not required to enter -->
      <input type="hidden" id="rpcUrl" value="https://rpc.soniclabs.com" />

      <label for="wallet">Wallet address</label>
      <div class="row">
        <input id="wallet" type="text" placeholder="0x… wallet address" autocomplete="off" />
        <button id="scanBtn">Scan</button>
      </div>
      <div id="status" class="muted small" style="margin-top:.5rem;"></div>
      <div id="error" class="error" role="alert"></div>
    </section>

    <section class="cols">
      <div class="card">
        <h3 style="margin:.25rem 0 .5rem;">Tokens Found</h3>
        <div id="tokens" class="list muted small">No results yet</div>
      </div>
      <div class="card">
        <h3 style="margin:.25rem 0 .5rem;">Selected token</h3>
        <div id="selected" class="list muted small">Select a token to view instances.</div>
      </div>
    </section>
  </div>

  <script>
    // --- Helpers -------------------------------------------------------------
    const $ = (id) => document.getElementById(id);
    const status = (msg) => { $("status").textContent = msg ?? ""; };
    const fail = (msg) => { $("error").textContent = msg ?? ""; };
    const clearMessages = () => { status(""); fail(""); };

    // Basic debounce to prevent double-click scans
    const disable = (el, on=true) => { el.disabled = !!on; };

    // Validate a hex EOA / contract address
    function isAddress(addr) {
      try {
        return !!ethers.isAddress(addr);
      } catch {
        return false;
      }
    }

    // Build provider once, from fixed RPC
    function createProvider() {
      const rpc = $("rpcUrl").value.trim();
      // ethers v6: use JsonRpcProvider
      return new ethers.JsonRpcProvider(rpc);
    }

    // --- Minimal on-chain scan stub -----------------------------------------
    async function scanAddress() {
      clearMessages();
      const btn = $("scanBtn");
      const wallet = $("wallet").value.trim();

      if (!wallet) {
        fail("Please enter a wallet address.");
        return;
      }
      if (!isAddress(wallet)) {
        fail("That doesn’t look like a valid address.");
        return;
      }

      disable(btn, true);
      status("Connecting to RPC and validating address…");
      try {
        const provider = createProvider();

        // Ping the chain to ensure RPC works
        const [network, block] = await Promise.all([
          provider.getNetwork(),
          provider.getBlockNumber()
        ]);

        status(`Connected to chain ${Number(network.chainId)} • latest block ${block}. Scanning…`);

        // TODO: Replace the logic below with your actual NFT discovery:
        //  - Query Transfer(address,address,uint256) logs for ERC‑721
        //  - Query TransferSingle/TransferBatch for ERC‑1155
        //  - Narrow by topics with the wallet in from/to
        // For now, we show a placeholder result so the UI updates consistently.
        const tokensEl = $("tokens");
        tokensEl.classList.remove("muted");
        tokensEl.textContent = ""; // clear

        const placeholder = document.createElement("div");
        placeholder.innerHTML = `
          <div style="padding:.4rem .5rem;border:1px solid #263044;border-radius:8px;">
            <div><strong>Sample Token</strong> (replace with real results)</div>
            <div class="small muted">Chain: ${Number(network.chainId)} • Block: ${block}</div>
          </div>`;
        tokensEl.appendChild(placeholder);

        $("selected").textContent = "Click a token to view instances (not wired yet).";

        status("Scan complete.");
      } catch (err) {
        console.error(err);
        // Show a concise error, but keep details in console
        fail(err?.message || "Scan failed. See console for details.");
      } finally {
        disable(btn, false);
      }
    }

    // --- Wire UI -------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", () => {
      // Ensure ethers is available early; prevents “ethers is not defined”
      if (typeof ethers === "undefined") {
        fail("Failed to load ethers.js. Check the CDN script tag.");
        return;
      }

      // Optional: Pre-fill an example address for quick testing
      // $("wallet").value = "0x0000000000000000000000000000000000000000";

      $("scanBtn").addEventListener("click", (e) => {
        e.preventDefault();
        scanAddress();
      });

      // Press Enter to scan
      $("wallet").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          $("scanBtn").click();
        }
      });
    });
  </script>
</body>
</html>
