<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonic On‑chain NFT Scanner (Explorer API)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --bg:#0b0e13; --panel:#131823; --txt:#e6e9ef; --muted:#9aa3b2; --accent:#66e7ff; --danger:#ff6b6b; --line:#202636; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    .wrap { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size:1.6rem; margin:.25rem 0 .5rem; }
    .muted { color:var(--muted); }
    .small { font-size:.9rem; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:1rem; }
    label { display:block; font-size:.9rem; color:var(--muted); margin:.75rem 0 .25rem; }
    input[type="text"], input[type="number"], input[type="password"] {
      width:100%; padding:.7rem .8rem; border:1px solid #263044; border-radius:10px; background:#0f1420; color:var(--txt);
    }
    .row { display:grid; grid-template-columns: 1fr auto auto; gap:.75rem; align-items:end; }
    button { padding:.75rem 1rem; background:var(--accent); color:#00242b; border:0; border-radius:10px; font-weight:600; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .cols { display:grid; gap:1rem; grid-template-columns: 1.1fr .9fr; margin-top:1rem; }
    .list { min-height: 220px; border:1px dashed #2b3448; border-radius:10px; padding:.75rem; overflow:auto; }
    .error { color:var(--danger); margin-top:.5rem; white-space:pre-wrap; }
    @media (max-width: 960px){ .cols { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr auto; } }
    .token { padding:.5rem .6rem; border:1px solid #263044; border-radius:8px; margin-bottom:.5rem; cursor:pointer; }
    .token:hover { border-color:#345; background:#0f1420; }
    .hdr { display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .pill { display:inline-block; background:#0f1420; border:1px solid #263044; border-radius:999px; padding:.1rem .5rem; font-size:.75rem; color:#9fc2ca; }
    summary { cursor:pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    progress { width: 100%; height: 10px; }
    a { color:#86f0ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sonic On‑chain NFT Scanner</h1>
      <p class="muted small">
        Uses the official Sonic <em>Explorer API</em> (Etherscan v2 on chainId 146) to derive current NFT holdings from transfer history —
        no explorer API key from SonicScan is needed.<br/>
        Network reference: RPC <code class="mono">https://rpc.soniclabs.com</code>, Explorer <code class="mono">https://sonicscan.org</code>,
        Explorer API base <code class="mono">https://api.etherscan.io/v2/api?chainid=146</code>. [1](https://www.soniclabs.com/)
      </p>
    </header>

    <section class="card">
      <!-- Fixed RPC field (informational, not used for scanning in this version) -->
      <input type="hidden" id="rpcUrl" value="https://rpc.soniclabs.com" />

      <label for="wallet">Wallet address</label>
      <div class="row">
        <input id="wallet" class="mono" type="text" placeholder="0x… wallet address" autocomplete="off" />
        <button id="scanBtn">Scan</button>
        <button id="stopBtn" style="background:#ffd166;color:#3a2f00;">Stop</button>
      </div>

      <details style="margin-top:.5rem;">
        <summary class="muted small">API & Advanced</summary>
        <div style="display:grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap:.75rem; margin-top:.5rem;">
          <div>
            <label for="apiKey">Etherscan API Key</label>
            <input id="apiKey" type="password" placeholder="Enter your key (kept in your browser)" />
          </div>
          <div>
            <label for="pageSize">Page size (offset)</label>
            <input id="pageSize" class="mono" type="number" min="50" max="10000" step="50" value="1000" />
          </div>
          <div>
            <label for="rateDelay">Rate‑limit delay (ms)</label>
            <input id="rateDelay" class="mono" type="number" min="0" step="50" value="250" />
          </div>
          <div>
            <label for="maxPages">Max pages (0 = all)</label>
            <input id="maxPages" class="mono" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="direction">Sort direction</label>
            <input id="direction" class="mono" type="text" value="asc" />
          </div>
        </div>
        <p class="muted small" style="margin:.5rem 0 0;">
          Tip: The default settings work well. If you hit API limits, increase the delay or reduce page size.
        </p>
      </details>

      <div style="margin-top:.5rem;">
        <progress id="prog" max="100" value="0"></progress>
      </div>

      <div id="status" class="muted small" style="margin-top:.5rem;"></div>
      <div id="error" class="error" role="alert"></div>
    </section>

    <section class="cols">
      <div class="card">
        <div class="hdr" style="margin-bottom:.5rem;">
          <h3 style="margin:0;">Tokens Found</h3>
          <span id="foundPill" class="pill">0 collections</span>
        </div>
        <div id="tokens" class="list muted small">No results yet</div>
      </div>

      <div class="card">
        <div class="hdr" style="margin-bottom:.5rem;">
          <h3 style="margin:0;">Selected token</h3>
          <span id="selPill" class="pill">—</span>
        </div>
        <div id="selected" class="list muted small">Select a collection to view all tokens the wallet holds for it.</div>
      </div>
    </section>
  </div>

  <script>
    // ----------------- Config -----------------
    const API_BASE = "https://api.etherscan.io/v2/api"; // Sonic mainnet explorer API
    const CHAIN_ID = 146; // Sonic mainnet chain id
    const PLACEHOLDER_KEY = "PLACEHOLDER_KEY"; // <<< replace in code OR paste at runtime in the API Key field

    // ----------------- Utilities & UI helpers -----------------
    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => $("status").textContent = msg ?? "";
    const setError  = (msg) => $("error").textContent  = msg ?? "";
    const clearMsgs = () => { setStatus(""); setError(""); };
    const fmt = (n) => new Intl.NumberFormat().format(n);
    const mono = (s) => `<span class="mono">${s}</span>`;
    const sleep = (ms) => new Promise(res => setTimeout(res, ms));
    let CANCEL = false;

    // ----------------- API client -----------------
    function getApiKey() {
      // Prefer the field; fall back to placeholder.
      const ui = $("apiKey").value.trim();
      return ui || PLACEHOLDER_KEY;
    }

    function buildUrl(params) {
      const usp = new URLSearchParams(params);
      usp.set("chainid", String(CHAIN_ID));
      usp.set("apikey", getApiKey());
      return `${API_BASE}?${usp.toString()}`;
    }

    async function fetchTransfersPaged(address, { pageSize = 1000, direction = "asc", maxPages = 0, delayMs = 250 } = {}, onProgress) {
      const all = [];
      let page = 1;
      let more = true;

      while (!CANCEL && more) {
        const url = buildUrl({
          module: "account",
          action: "tokennfttx",
          address,
          page,
          offset: pageSize,
          sort: direction
        });

        let json;
        try {
          const resp = await fetch(url, { mode: "cors", cache: "no-store" });
          json = await resp.json();
        } catch (e) {
          throw new Error(`Network error calling explorer API (page ${page}).`);
        }

        // Etherscan-style responses:
        // status: "1" success, "0" (no result or error) with message; result: [] or error text
        if (!json || typeof json !== "object") {
          throw new Error(`Invalid API response (page ${page}).`);
        }

        if (json.status === "0" && Array.isArray(json.result) && json.result.length === 0) {
          // No more results
          more = false;
        } else if (json.status === "1" && Array.isArray(json.result)) {
          all.push(...json.result);
          setStatus(`Fetched ${fmt(all.length)} transfer events (page ${fmt(page)}).`);
        } else {
          // Some APIs return an error string in result when rate-limited
          const msg = json.message || json.result || "Unknown API error";
          throw new Error(`Explorer API error (page ${page}): ${msg}`);
        }

        onProgress && onProgress(page);
        page += 1;
        if (maxPages > 0 && page > maxPages) break;
        if (more) await sleep(delayMs);
      }

      return all;
    }

    // ----------------- Holdings derivation -----------------
    function deriveHoldings(address, transfers) {
      const wallet = address.toLowerCase();
      // collections: Map<contract, {name, symbol, ids: Map<id, BigInt>, inferredStandard:"ERC721"|"ERC1155"|"Unknown"}>
      const collections = new Map();

      for (const t of transfers) {
        // expected fields: contractAddress, tokenID, tokenValue, tokenName, tokenSymbol, from, to
        const contract = (t.contractAddress || t.contract || "").toLowerCase();
        if (!contract || !t.tokenID) continue;

        const from = (t.from || t.fromAddress || "").toLowerCase();
        const to   = (t.to   || t.toAddress   || "").toLowerCase();
        const id   = String(t.tokenID);
        // tokenValue present for ERC‑1155; Etherscan sets "1" for 721
        let val = 1n;
        try {
          if (t.tokenValue !== undefined && t.tokenValue !== null && t.tokenValue !== "") {
            val = BigInt(t.tokenValue);
          }
        } catch { val = 1n; }

        let entry = collections.get(contract);
        if (!entry) {
          entry = { name: t.tokenName || null, symbol: t.tokenSymbol || null, ids: new Map(), inferredStandard: "Unknown" };
          collections.set(contract, entry);
        }

        // Apply net flow
        const cur = entry.ids.get(id) || 0n;
        let next = cur;
        if (from === wallet) next -= val;
        if (to   === wallet) next += val;
        entry.ids.set(id, next);

        // Infer standard heuristically:
        // - if any transfer has value != 1 → likely ERC‑1155
        // - else default to ERC‑721
        if (entry.inferredStandard !== "ERC1155") {
          entry.inferredStandard = (val !== 1n) ? "ERC1155" : entry.inferredStandard;
        }
      }

      // Finalize: remove zero/negative balances; decide Unknown→ERC721 by default
      const result = [];
      for (const [contract, entry] of collections.entries()) {
        const owned = [];
        let sawValueGt1 = false;
        for (const [id, bal] of entry.ids.entries()) {
          if (bal > 0n) {
            owned.push({ id, bal });
            if (bal > 1n) sawValueGt1 = true;
          }
        }
        if (owned.length === 0) continue;

        let standard = entry.inferredStandard;
        if (standard === "Unknown") {
          // If any final balance >1, must be 1155; else treat as 721
          standard = sawValueGt1 ? "ERC1155" : "ERC721";
        }

        // Sort token IDs numerically (as BigInt)
        owned.sort((a,b) => (BigInt(a.id) > BigInt(b.id) ? 1 : -1));
        result.push({
          address: contract,
          name: entry.name,
          symbol: entry.symbol,
          standard,
          ids: owned
        });
      }

      // Sort collections by token count desc, then by name/address
      result.sort((a,b) => (b.ids.length - a.ids.length) ||
                           ((a.name||"").localeCompare(b.name||"")) ||
                           a.address.localeCompare(b.address));
      return result;
    }

    // ----------------- Rendering -----------------
    function renderCollections(list) {
      const tokensEl = $("tokens");
      tokensEl.textContent = "";
      if (!list || list.length === 0) {
        tokensEl.classList.add("muted");
        tokensEl.textContent = "No NFTs found for this wallet (in the fetched transfer history).";
        $("foundPill").textContent = "0 collections";
        $("selected").textContent = "—";
        $("selPill").textContent = "—";
        return;
      }

      $("foundPill").textContent = `${list.length} collection${list.length>1?"s":""}`;
      for (const col of list) {
        const div = document.createElement("div");
        div.className = "token";
        const title = col.name ? `${escapeHtml(col.name)}${col.symbol ? " ("+escapeHtml(col.symbol)+")" : ""}` : col.address;
        const link = `https://sonicscan.org/token/${col.address}`; // best-effort explorer link
        div.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
            <div>
              <div><strong>${title}</strong></div>
              <div class="small muted mono">${col.address} • <a href="${link}" target="_blank" rel="noopener">View on SonicScan</a></div>
            </div>
            <div class="pill">${col.standard} • ${fmt(col.ids.length)} token${col.ids.length>1?"s":""}</div>
          </div>`;
        div.addEventListener("click", () => renderCollectionDetail(col));
        tokensEl.appendChild(div);
      }
    }

    function renderCollectionDetail(col) {
      const sel = $("selected");
      sel.textContent = "";
      $("selPill").textContent = `${col.standard} • ${fmt(col.ids.length)} token${col.ids.length>1?"s":""}`;

      const header = document.createElement("div");
      const title = col.name ? `${escapeHtml(col.name)}${col.symbol ? " ("+escapeHtml(col.symbol)+")" : ""}` : col.address;
      header.innerHTML = `
        <div style="margin-bottom:.5rem;">
          <div><strong>${title}</strong></div>
          <div class="small muted mono">${col.address}</div>
        </div>`;
      sel.appendChild(header);

      const box = document.createElement("div"); box.className = "list";
      for (const {id, bal} of col.ids) {
        const row = document.createElement("div");
        row.className = "token";
        if (col.standard === "ERC721") {
          row.innerHTML = `<div class="mono">tokenId: ${id}</div>`;
        } else {
          row.innerHTML = `<div class="mono">id: ${id}</div><div class="small muted">balance: ${bal.toString()}</div>`;
        }
        box.appendChild(row);
      }
      sel.appendChild(box);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ----------------- Main flow -----------------
    async function scanViaExplorer() {
      clearMsgs();
      $("tokens").classList.remove("muted");
      $("tokens").textContent = "";
      $("selected").textContent = "Scanning…";
      $("selPill").textContent = "—";
      $("foundPill").textContent = "0 collections";
      $("prog").value = 0;
      CANCEL = false;

      const scanBtn = $("scanBtn"), stopBtn = $("stopBtn");
      scanBtn.disabled = true; stopBtn.disabled = false;

      const addressRaw = $("wallet").value.trim();
      if (!/^0x[a-fA-F0-9]{40}$/.test(addressRaw)) {
        setError("Please enter a valid EVM address (0x…40 hex chars).");
        scanBtn.disabled = false; stopBtn.disabled = true;
        return;
      }
      const address = addressRaw.toLowerCase();

      const pageSize = Math.max(50, Math.min(10000, parseInt($("pageSize").value || "1000", 10)));
      const delayMs  = Math.max(0,  parseInt($("rateDelay").value || "250", 10));
      const maxPages = Math.max(0,  parseInt($("maxPages").value || "0",   10));
      const sortDir  = (String($("direction").value || "asc").toLowerCase() === "desc") ? "desc" : "asc";

      setStatus("Querying explorer for NFT transfer history…");
      let lastPageProgress = 0;
      const transfers = await fetchTransfersPaged(address, {
        pageSize,
        direction: sortDir,
        maxPages,
        delayMs
      }, (page) => {
        lastPageProgress = page;
        // Progress is unknown total; show pseudo progress capped at 90% until final derivation.
        $("prog").value = Math.min(90, lastPageProgress * 5); // heuristic visual feedback
      }).catch((e) => {
        setError(e.message || "Explorer API error.");
        scanBtn.disabled = false; stopBtn.disabled = true;
        return null;
      });

      if (CANCEL) {
        setStatus("Scan canceled.");
        scanBtn.disabled = false; stopBtn.disabled = true;
        return;
      }
      if (!transfers) return;

      setStatus(`Fetched ${fmt(transfers.length)} transfer events. Deriving current holdings…`);
      // Finish progress
      $("prog").value = 95;

      const collections = deriveHoldings(address, transfers);
      renderCollections(collections);

      $("prog").value = 100;
      setStatus(`Scan complete. Collections: ${fmt(collections.length)}.`);
      scanBtn.disabled = false; stopBtn.disabled = true;
    }

    // ----------------- Wire UI -----------------
    window.addEventListener("DOMContentLoaded", () => {
      $("scanBtn").addEventListener("click", (e) => { e.preventDefault(); scanViaExplorer(); });
      $("stopBtn").addEventListener("click", (e) => { e.preventDefault(); CANCEL = true; setStatus("Stopping…"); });
      $("wallet").addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); scanViaExplorer(); } });

      // Pre-fill placeholder key in field (visually hidden via password type)
      $("apiKey").value = PLACEHOLDER_KEY;
    });
  </script>
</body>
</html>
